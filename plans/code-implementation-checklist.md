# éŸ³é¢‘åŠ è½½ä¼˜åŒ– - ä»£ç å®æ–½æ¸…å•

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸º Code æ¨¡å¼æä¾›è¯¦ç»†çš„ä»£ç ä¿®æ”¹æ¸…å•ï¼ŒåŒ…æ‹¬éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ã€éœ€è¦ä¿®æ”¹çš„ä»£ç ä½ç½®å’Œå…·ä½“çš„ä»£ç å†…å®¹ã€‚

## å®æ–½æ¸…å•

### âœ… ä»»åŠ¡ 1: åˆ›å»ºéŸ³é¢‘åŠ è½½é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `game/systems/AudioLoadingConfig.ts`ï¼ˆæ–°å»ºï¼‰

**æ“ä½œ**: åˆ›å»ºæ–°æ–‡ä»¶

**ä»£ç **: å‚è€ƒ [`audio-loading-implementation.md`](./audio-loading-implementation.md) ç¬¬ 1 èŠ‚å®Œæ•´ä»£ç 

**å…³é”®ç‚¹**:
- å®šä¹‰ `AudioLoadingPriority` ç±»å‹
- å®šä¹‰ `AudioLoadingRule` æ¥å£
- åˆ›å»º `AUDIO_LOADING_RULES` é…ç½®æ•°ç»„
- å¯¼å‡ºè¾…åŠ©å‡½æ•° `findAudioLoadingRule()` å’Œ `getAudioLoadingRulesByPriority()`

**éªŒè¯**: TypeScript ç¼–è¯‘æ— é”™è¯¯

---

### âœ… ä»»åŠ¡ 2: ä¿®æ”¹ SoundManager.ts - å¯¼å…¥é…ç½®

**æ–‡ä»¶**: `game/systems/SoundManager.ts`

**ä½ç½®**: æ–‡ä»¶é¡¶éƒ¨ï¼ˆç¬¬ 4 è¡Œä¹‹åï¼‰

**æ“ä½œ**: æ·»åŠ å¯¼å…¥è¯­å¥

**ä»£ç **:
```typescript
import { AUDIO_LOADING_RULES, type AudioLoadingPriority } from './AudioLoadingConfig';
```

**éªŒè¯**: TypeScript ç¼–è¯‘æ— é”™è¯¯

---

### âœ… ä»»åŠ¡ 3: ä¿®æ”¹ SoundManager.ts - getAllManifestUrls() æ–¹æ³•

**æ–‡ä»¶**: `game/systems/SoundManager.ts`

**ä½ç½®**: ç¬¬ 1536 è¡Œï¼ˆ`private getAllManifestUrls()` æ–¹æ³•ï¼‰

**æ“ä½œ**: æ›¿æ¢æ•´ä¸ªæ–¹æ³•

**åŸä»£ç **:
```typescript
private getAllManifestUrls(): string[] {
  const folders = this.getFolders();
  if (!folders || typeof folders !== 'object') return [];
  const out: string[] = [];
  const seen = new Set<string>();
  for (const urls of Object.values(folders)) {
    if (!Array.isArray(urls)) continue;
    for (const url of urls) {
      if (!url || seen.has(url)) continue;
      seen.add(url);
      out.push(url);
    }
  }
  return out;
}
```

**æ–°ä»£ç **: å‚è€ƒ [`audio-loading-implementation.md`](./audio-loading-implementation.md) ä¿®æ”¹ç‚¹ 2

**å…³é”®å˜æ›´**:
- æ·»åŠ å¯é€‰å‚æ•° `priority?: AudioLoadingPriority`
- éå† `Object.entries(folders)` è€Œä¸æ˜¯ `Object.values(folders)`
- æ·»åŠ è§„åˆ™åŒ¹é…é€»è¾‘
- æ ¹æ® `samplesCount` é™åˆ¶æ¯ä¸ªæ–‡ä»¶å¤¹çš„æ ·æœ¬æ•°é‡

**éªŒè¯**: TypeScript ç¼–è¯‘æ— é”™è¯¯

---

### âœ… ä»»åŠ¡ 4: ä¿®æ”¹ SoundManager.ts - ensureSessionAudioPack() æ–¹æ³•

**æ–‡ä»¶**: `game/systems/SoundManager.ts`

**ä½ç½®**: ç¬¬ 1574 è¡Œï¼ˆ`public ensureSessionAudioPack()` æ–¹æ³•ï¼‰

**æ“ä½œ**: ä¿®æ”¹æ–¹æ³•ç­¾åå’Œå®ç°

**å…³é”®å˜æ›´**:
1. ä¿®æ”¹å‚æ•°ç±»å‹ï¼Œæ·»åŠ  `priority?: AudioLoadingPriority`
2. åœ¨æ–¹æ³•å¼€å¤´æ·»åŠ ä¼˜å…ˆçº§åŠ è½½é€»è¾‘ï¼ˆç‹¬ç«‹ä»»åŠ¡ï¼‰
3. ä¿æŒåŸæœ‰å…¨é‡åŠ è½½é€»è¾‘ï¼ˆå‘åå…¼å®¹ï¼‰

**æ–°ä»£ç **: å‚è€ƒ [`audio-loading-implementation.md`](./audio-loading-implementation.md) ä¿®æ”¹ç‚¹ 3

**éªŒè¯**: TypeScript ç¼–è¯‘æ— é”™è¯¯

---

### âœ… ä»»åŠ¡ 5: ä¿®æ”¹ MenuScene.ts - åˆ†é˜¶æ®µåŠ è½½

**æ–‡ä»¶**: `game/MenuScene.ts`

**ä½ç½®**: ç¬¬ 129 è¡Œ

**æ“ä½œ**: æ›¿æ¢å•è¡Œä»£ç ä¸ºå¤šè¡Œåˆ†é˜¶æ®µåŠ è½½

**åŸä»£ç **:
```typescript
await this.menuAudio.ensureSessionAudioPack({ concurrency: 5 });
```

**æ–°ä»£ç **: å‚è€ƒ [`audio-loading-implementation.md`](./audio-loading-implementation.md) ç¬¬ 3 èŠ‚

**å…³é”®å˜æ›´**:
- P0 é˜»å¡åŠ è½½ï¼ˆawaitï¼‰
- P1 åå°åŠ è½½ï¼ˆä¸ awaitï¼‰
- P2 å»¶è¿ŸåŠ è½½ï¼ˆ10 ç§’åï¼‰

**éªŒè¯**: 
- TypeScript ç¼–è¯‘æ— é”™è¯¯
- æ¸¸æˆå¯åŠ¨æµç¨‹æ­£å¸¸

---

## å¯é€‰ä»»åŠ¡

### ğŸ“Š ä»»åŠ¡ 6: åˆ›å»ºéŸ³æ•ˆç»Ÿè®¡è„šæœ¬ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**: `scripts/count-audio-samples.js`ï¼ˆæ–°å»ºï¼‰

**æ“ä½œ**: åˆ›å»º Node.js è„šæœ¬ç”¨äºç»Ÿè®¡éŸ³æ•ˆæ–‡ä»¶

**ç”¨é€”**: éªŒè¯ä¼˜åŒ–æ•ˆæœï¼Œç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

**è¿è¡Œ**: `node scripts/count-audio-samples.js`

**æ³¨æ„**: æ­¤ä»»åŠ¡ä¸ºå¯é€‰ï¼Œä¸»è¦ç”¨äºéªŒè¯å’Œåˆ†æ

---

## å®æ–½é¡ºåº

å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®æ–½ï¼š

1. **ä»»åŠ¡ 1** â†’ åˆ›å»ºé…ç½®æ–‡ä»¶ï¼ˆç‹¬ç«‹ï¼Œæ— ä¾èµ–ï¼‰
2. **ä»»åŠ¡ 2** â†’ å¯¼å…¥é…ç½®ï¼ˆä¾èµ–ä»»åŠ¡ 1ï¼‰
3. **ä»»åŠ¡ 3** â†’ ä¿®æ”¹ getAllManifestUrlsï¼ˆä¾èµ–ä»»åŠ¡ 2ï¼‰
4. **ä»»åŠ¡ 4** â†’ ä¿®æ”¹ ensureSessionAudioPackï¼ˆä¾èµ–ä»»åŠ¡ 3ï¼‰
5. **ä»»åŠ¡ 5** â†’ ä¿®æ”¹ MenuSceneï¼ˆä¾èµ–ä»»åŠ¡ 4ï¼‰
6. **æµ‹è¯•éªŒè¯** â†’ è¿è¡Œæ¸¸æˆï¼ŒéªŒè¯åŠ è½½æ—¶é—´å’ŒéŸ³æ•ˆæ’­æ”¾

---

## æµ‹è¯•éªŒè¯æ­¥éª¤

### 1. ç¼–è¯‘æµ‹è¯•
```bash
npm run build
```
- ç¡®ä¿æ—  TypeScript ç¼–è¯‘é”™è¯¯

### 2. å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
npm run dev
```
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
- åˆ‡æ¢åˆ° Network æ ‡ç­¾
- æ¸…é™¤ç¼“å­˜ï¼ˆCtrl+Shift+Deleteï¼‰
- åˆ·æ–°é¡µé¢
- è§‚å¯ŸåŠ è½½çš„éŸ³æ•ˆæ–‡ä»¶æ•°é‡å’Œæ—¶é—´

### 3. æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡**:
- P0 åŠ è½½æ–‡ä»¶æ•°ï¼šé¢„æœŸ ~37 ä¸ª
- P0 åŠ è½½æ—¶é—´ï¼šé¢„æœŸ 5-15 ç§’ï¼ˆä¸­å›½å¢ƒå†…è®¿é—®å¢ƒå¤–æœåŠ¡å™¨ï¼‰
- é¦–æ¬¡å¯ç©æ—¶é—´ï¼šé¢„æœŸ 5-15 ç§’

**æµ‹è¯•æ–¹æ³•**:
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. æ‰“å¼€å¼€å‘è€…å·¥å…· Console
3. è®°å½• P0 åŠ è½½å®Œæˆçš„æ—¶é—´
4. éªŒè¯æ¸¸æˆå¯æ­£å¸¸è¿›å…¥å’Œæ’­æ”¾éŸ³æ•ˆ

### 4. åŠŸèƒ½æµ‹è¯•

**å¿…æµ‹éŸ³æ•ˆ**:
- âœ… BGM æ’­æ”¾æ­£å¸¸
- âœ… æ ‡å‡†ç‚®å¼¹å¼€ç«éŸ³æ•ˆï¼ˆé«˜é¢‘ï¼‰
- âœ… æ ‡å‡†ç‚®å¼¹çˆ†ç‚¸éŸ³æ•ˆï¼ˆé«˜é¢‘ï¼‰
- âœ… ç©å®¶å¦å…‹å¼•æ“éŸ³æ•ˆ
- âœ… ç¯å¢ƒå¾ªç¯éŸ³ï¼ˆæ£®æ—ã€é£å£°ç­‰ï¼‰

**å¯é€‰æµ‹è¯•**:
- æ•Œæ–¹è½¦è¾†éŸ³æ•ˆ
- ç¯å¢ƒç”Ÿç‰©éŸ³æ•ˆ
- å»ºç­‘å€’å¡ŒéŸ³æ•ˆ

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

### å¿«é€Ÿå›æ»šï¼ˆä¿ç•™ä»£ç ï¼Œä¸´æ—¶ç¦ç”¨ï¼‰

åœ¨ `MenuScene.ts` ç¬¬ 129 è¡Œï¼š
```typescript
// ä¸´æ—¶å›æ»šåˆ°åŸæœ‰é€»è¾‘
await this.menuAudio.ensureSessionAudioPack({ concurrency: 5 });

// æ³¨é‡Šæ‰ä¼˜åŒ–ä»£ç 
// await this.menuAudio.ensureSessionAudioPack({ priority: 'P0', concurrency: 5 });
// this.menuAudio.ensureSessionAudioPack({ priority: 'P1', concurrency: 3 }).catch(...);
// this.time.delayedCall(10000, () => { ... });
```

### å®Œå…¨å›æ»šï¼ˆåˆ é™¤æ‰€æœ‰ä¿®æ”¹ï¼‰

1. åˆ é™¤ `game/systems/AudioLoadingConfig.ts`
2. æ¢å¤ `game/systems/SoundManager.ts`:
   - åˆ é™¤å¯¼å…¥è¯­å¥
   - æ¢å¤ `getAllManifestUrls()` æ–¹æ³•
   - æ¢å¤ `ensureSessionAudioPack()` æ–¹æ³•
3. æ¢å¤ `game/MenuScene.ts` ç¬¬ 129 è¡Œ

---

## é¢„æœŸç»“æœ

### åŠ è½½æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| é¦–æ¬¡åŠ è½½æ–‡ä»¶æ•° | ~1000-1300 | ~37 | â†“ 97% |
| é¦–æ¬¡åŠ è½½æ—¶é—´ | 120-180 ç§’ | 5-15 ç§’ | â†“ 92-96% |
| é¦–æ¬¡å¯ç©æ—¶é—´ | 120-180 ç§’ | 5-15 ç§’ | â†“ 92-96% |
| P0+P1 åŠ è½½æ—¶é—´ | 120-180 ç§’ | 20-40 ç§’ | â†“ 78-83% |

### Console è¾“å‡ºç¤ºä¾‹

ä¼˜åŒ–åï¼ŒConsole åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
P0 Loading: 10/37
P0 Loading: 20/37
P0 Loading: 37/37
[Game] P0 audio pack loaded in 8.5s
[Game] Starting P1 background loading...
P1 Loading: 30/85
P1 Loading: 60/85
P1 Loading: 85/85
[Game] P1 audio pack loaded in 15.2s
```

---

## å¸¸è§é—®é¢˜

### Q1: æŸäº›éŸ³æ•ˆé¦–æ¬¡æ’­æ”¾æ—¶æœ‰å»¶è¿Ÿæ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥è¯¥éŸ³æ•ˆçš„ä¼˜å…ˆçº§é…ç½®ï¼Œè€ƒè™‘å°†å…¶æå‡åˆ° P0 æˆ– P1ã€‚

### Q2: P0 åŠ è½½æ—¶é—´ä»ç„¶å¾ˆé•¿æ€ä¹ˆåŠï¼Ÿ

**A**: 
1. æ£€æŸ¥ç½‘ç»œç¯å¢ƒï¼ˆä½¿ç”¨ Chrome DevTools çš„ Network æ ‡ç­¾ï¼‰
2. è€ƒè™‘å‡å°‘ P0 çš„æ ·æœ¬æ•°é‡ï¼ˆå¦‚ä» 3 ä¸ªå‡å°‘åˆ° 2 ä¸ªï¼‰
3. è€ƒè™‘ä½¿ç”¨ CDN åŠ é€Ÿ

### Q3: æ¸¸æˆå¯åŠ¨åéŸ³æ•ˆæ’­æ”¾ä¸æ­£å¸¸æ€ä¹ˆåŠï¼Ÿ

**A**:
1. æ£€æŸ¥ Console æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
2. éªŒè¯ P0 éŸ³æ•ˆæ˜¯å¦å…¨éƒ¨åŠ è½½æˆåŠŸ
3. æ£€æŸ¥éŸ³æ•ˆæ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
4. å°è¯•å¿«é€Ÿå›æ»šæ–¹æ¡ˆ

### Q4: å¦‚ä½•è°ƒæ•´ä¼˜å…ˆçº§é…ç½®ï¼Ÿ

**A**: ä¿®æ”¹ `game/systems/AudioLoadingConfig.ts` ä¸­çš„ `AUDIO_LOADING_RULES` æ•°ç»„ï¼Œè°ƒæ•´ `priority` å’Œ `samplesCount` å‚æ•°ã€‚

---

## åç»­ä¼˜åŒ–å»ºè®®

å®ŒæˆåŸºç¡€ä¼˜åŒ–åï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹è¿›é˜¶ä¼˜åŒ–ï¼š

1. **åŠ¨æ€æ ·æœ¬è¡¥å……**: ç›‘æ§éŸ³æ•ˆæ’­æ”¾é¢‘ç‡ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤šæ ·æœ¬
2. **æ™ºèƒ½é¢„åŠ è½½**: æ ¹æ®æ¸¸æˆè¿›åº¦é¢„æµ‹éœ€è¦çš„éŸ³æ•ˆ
3. **CDN åŠ é€Ÿ**: ä½¿ç”¨ä¸­å›½å¢ƒå†… CDNï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰
4. **éŸ³æ•ˆå‹ç¼©**: è¿›ä¸€æ­¥å‹ç¼©éŸ³æ•ˆæ–‡ä»¶å¤§å°
5. **Service Worker ç¼“å­˜**: å®ç°æŒä¹…åŒ–ç¼“å­˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2026-02-15  
**é€‚ç”¨æ¨¡å¼**: Code Mode  
**ç›¸å…³æ–‡æ¡£**: 
- [ä¼˜åŒ–æ–¹æ¡ˆ](./audio-loading-optimization-plan.md)
- [éŸ³æ•ˆç»Ÿè®¡](./audio-samples-statistics.md)
- [æŠ€æœ¯å®æ–½](./audio-loading-implementation.md)
